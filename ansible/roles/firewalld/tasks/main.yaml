---
- name: install dependencies
  apt:
    name:
      - firewalld
    state: present

- name: remove ufw
  apt:
    name: ufw
    state: absent

- name: enable and start firewalld
  service:
    name: firewalld
    enabled: yes
    state: started

- name: secure default interface
  firewalld:
    interface: '{{ ansible_default_ipv4.interface }}'
    zone: public
    permanent: yes
    state: enabled
  notify: reload_firewalld

- name: set tun0 as trusted
  firewalld:
    interface: tun0
    zone: trusted
    permanent: yes
    state: enabled
  notify: reload_firewalld

- name: allow masquerade for internal zone
  firewalld:
    zone: internal
    masquerade: yes
    permanent: yes
    state: enabled
  notify: reload_firewalld

- name: allow dhcp server for internal zone
  firewalld:
    zone: internal
    service: '{{ item }}'
    permanent: yes
    state: enabled
  notify: reload_firewalld
  loop:
    - dhcp
    - dhcpv6

- name: set lxc interface as internal
  firewalld:
    interface: '{{ firewalld_lxc_interface }}'
    zone: internal
    permanent: yes
    state: enabled
  notify: reload_firewalld

- name: create systemd override dirs
  file:
    path: '{{ item }}'
    state: 'directory'
  loop:
    - '{{ firewalld_lxc_net_systemd_override_dir }}'

- name: override lxc-net.service to work properly
  template:
    src: override.lxc-net.conf
    dest: '{{ firewalld_lxc_net_systemd_override_dir }}/override.conf'
    owner: root
    group: root
    mode: 0644
  notify:
    - reload_systemd
    - restart_firewalld
